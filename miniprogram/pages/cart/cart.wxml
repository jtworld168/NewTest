<wxs module="f" src="../../utils/filter.wxs"></wxs>
<view class="container">
  <!-- Not logged in / Empty -->
  <view class="empty-state" wx:if="{{!loading && !cartItems.length}}">
    <text class="empty-icon">ğŸ›’</text>
    <text class="empty-text">è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</text>
    <button class="btn-primary go-shop-btn" bindtap="goShopping">å»é€›é€›</button>
  </view>

  <!-- Cart Items -->
  <view wx:if="{{cartItems.length > 0}}">
    <!-- Clear button -->
    <view class="cart-header">
      <text class="cart-title">è´­ç‰©è½¦ ({{cartItems.length}})</text>
      <text class="clear-btn" bindtap="clearCart">æ¸…ç©º</text>
    </view>

    <view class="cart-item" wx:for="{{cartItems}}" wx:key="id">
      <!-- Checkbox -->
      <view class="checkbox {{selectedIds.indexOf(item.id) > -1 ? 'checked' : ''}}" bindtap="toggleSelect" data-id="{{item.id}}">
        <text wx:if="{{selectedIds.indexOf(item.id) > -1}}">âœ“</text>
      </view>

      <!-- Product image -->
      <image class="item-image" src="{{item._imageUrl || '/images/product-placeholder.png'}}" mode="aspectFill"></image>

      <!-- Info -->
      <view class="item-info">
        <text class="item-name">{{item._productName || 'å•†å“'}}</text>
        <view class="item-price-row">
          <text class="price">Â¥{{item._price || '0'}}</text>
          <text class="employee-price" wx:if="{{isEmployee && item._employeePrice}}">
            å‘˜å·¥ä»· Â¥{{item._employeePrice}}
          </text>
        </view>
        <view class="item-subtotal-row">
          <text class="subtotal-label">å°è®¡: </text>
          <text class="subtotal-price">Â¥{{item._subtotal}}</text>
        </view>
        <view class="quantity-control">
          <view class="qty-btn" bindtap="changeQuantity" data-id="{{item.id}}" data-action="minus">-</view>
          <text class="qty-num">{{item.quantity}}</text>
          <view class="qty-btn" bindtap="changeQuantity" data-id="{{item.id}}" data-action="add">+</view>
          <view class="delete-btn" bindtap="deleteItem" data-id="{{item.id}}">åˆ é™¤</view>
        </view>
      </view>
    </view>

    <!-- Coupon Section -->
    <view class="coupon-section" wx:if="{{!isEmployee && availableCoupons.length > 0}}">
      <view class="coupon-header" bindtap="toggleCouponPicker">
        <text class="coupon-label">ğŸ« ä¼˜æƒ åˆ¸</text>
        <text class="coupon-selected" wx:if="{{selectedCouponId}}">å·²é€‰ -Â¥{{selectedCouponDiscount}}</text>
        <text class="coupon-selected" wx:else>{{availableCoupons.length}}å¼ å¯ç”¨</text>
        <text class="menu-arrow">></text>
      </view>
      <view class="coupon-picker" wx:if="{{showCouponPicker}}">
        <view class="coupon-option" wx:for="{{availableCoupons}}" wx:key="id" bindtap="selectCoupon" data-id="{{item.id}}">
          <view class="coupon-option-left">
            <text class="coupon-option-amount">Â¥{{item.discount}}</text>
          </view>
          <view class="coupon-option-right">
            <text class="coupon-option-name">{{item.couponName}}</text>
            <text class="coupon-option-condition">æ»¡{{item.minAmount}}å…ƒå¯ç”¨</text>
          </view>
          <text class="coupon-check" wx:if="{{selectedCouponId === item.id}}">âœ“</text>
        </view>
        <view class="coupon-option" bindtap="clearCoupon">
          <text class="coupon-option-name" style="color: #999;">ä¸ä½¿ç”¨ä¼˜æƒ åˆ¸</text>
        </view>
      </view>
    </view>

    <!-- Employee discount notice -->
    <view class="employee-notice" wx:if="{{isEmployee && hasEmployeeDiscount}}">
      <text>ğŸ·ï¸ å‘˜å·¥æŠ˜æ‰£å·²åº”ç”¨ | åŸä»· Â¥{{totalPrice}} â†’ æŠ˜å Â¥{{employeeTotal}}</text>
    </view>

    <!-- Cannot use coupon notice for employees -->
    <view class="employee-notice" wx:if="{{isEmployee && availableCoupons.length > 0}}">
      <text>ğŸ’¡ å‘˜å·¥æŠ˜æ‰£ä¸ä¼˜æƒ åˆ¸ä¸å¯å åŠ ä½¿ç”¨</text>
    </view>

    <!-- Bottom Bar -->
    <view class="bottom-bar">
      <view class="select-all" bindtap="toggleSelectAll">
        <view class="checkbox {{selectedIds.length === cartItems.length ? 'checked' : ''}}">
          <text wx:if="{{selectedIds.length === cartItems.length}}">âœ“</text>
        </view>
        <text>å…¨é€‰</text>
      </view>
      <view class="total">
        <text>åˆè®¡: </text>
        <text class="price">Â¥{{finalPrice}}</text>
      </view>
      <button class="checkout-btn" bindtap="checkout">ç»“ç®— ({{selectedIds.length}})</button>
    </view>
  </view>

  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>
